# プロジェクトドキュメント

## 概要
- プロンプト共有プラットフォームのバックエンド（FastAPI + SQLAlchemy + Redis）
- 機能：認証、メール連携、パスワード再設定、プロンプトCRUD、いいね/お気に入り、閲覧統計、マイページ、グローバル統計

## 技術スタック
- Python 3.11+
- FastAPI、SQLAlchemy（非同期）
- PostgreSQL、Redis
- JWT認証

## セットアップ・依存関係
- uv（推奨）：
  - `curl -LsSf https://astral.sh/uv/install.sh | sh`
  - `uv sync`
- pip：
  - `pip install -r requirements.txt`

## 環境変数
- `DATABASE_URL=postgresql+asyncpg://user:password@host:5432/dbname`
- `REDIS_URL=redis://host:6379/0`
- `SECRET_KEY=your-secret`
- メール：`SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASSWORD`、`SMTP_FROM`

## 実行方法
- 開発：`uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
- Docker ビルド：`docker build -t prompt-words-back-end .`
- Docker 実行：`docker run --rm -p 8000:8000 --env-file .env prompt-words-back-end`

## ユーティリティ
- DB初期化：`python init_db.py`
- 起動スクリプト：`bash run.sh`
- 簡単なAPIテスト：`uv run python test_api.py`

## API クイックリファレンス
- 認証：
  - `POST /auth/register`
  - `POST /auth/login`
  - `POST /auth/send-code`
  - `POST /auth/bind-email`
  - `POST /auth/reset-password`
  - `POST /auth/logout`
- プロンプト：
  - `POST /prompts`
  - `GET /prompts?page=1&page_size=10`
  - `GET /prompts/{promptId}`
  - `PUT /prompts/{promptId}`
  - `DELETE /prompts/{promptId}`
  - `GET /prompts/user/my-prompts`
  - `GET /prompts/stats/global`

## API サンプル

### 登録・ログイン
リクエスト：
```json
POST /auth/register
{"username":"testuser","password":"123456"}
```
レスポンス：
```json
{"code":200,"data":{"accessToken":"...","tokenType":"bearer","user":{"id":1,"username":"testuser","email":null,"state":0,"createdAt":"..."}},"msg":"成功"}
```

```json
POST /auth/login
{"username":"testuser","password":"123456"}
```

### メールコード・紐付け
送信：
```json
POST /auth/send-code
{"email":"user@example.com"}
```
紐付け：
```json
POST /auth/bind-email（Bearer トークン必要）
{"email":"user@example.com","code":"123456"}
```

パスワード再設定：
```json
POST /auth/reset-password
{"email":"user@example.com","code":"123456","newPassword":"654321"}
```

ログアウト：
```json
POST /auth/logout（Bearer トークン必要）
{}
```

### プロンプト CRUD
作成：
```json
POST /prompts（トークン必要）
{"title":"サンプル","content":"..."}
```
一覧：
```text
GET /prompts?page=1&page_size=10
```
詳細（IP制限の閲覧記録）：
```text
GET /prompts/123
```
更新：
```json
PUT /prompts/123（本人＋トークン）
{"title":"新規","content":"更新"}
```
削除（ソフト削除）：
```text
DELETE /prompts/123（本人＋トークン）
```

### いいね／お気に入りトグル
```text
POST /prompts/123/like（トークン）     # 再度呼ぶと取消
POST /prompts/123/favorite（トークン） # 再度呼ぶと取消
```

### マイリスト
```text
GET /prompts/user/my-prompts（トークン）
GET /prompts/user/favorites（トークン）
GET /prompts/user/likes（トークン）
```

### グローバル統計
```text
GET /prompts/stats/global
```

## 備考
- Swagger：`http://localhost:8000/docs`
- レスポンス形式：`{"code":200,"data":{},"msg":"成功"}`（camelCase）

## フロントエンド連携
- リポジトリ：`https://github.com/mhxy13867806343/prompt-words-front-end`
- プレフィックス：`/{...}` と `/api/{...}` の両方をサポート、`/api` を推奨
- Vite プロキシ例：
  ```ts
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
  ```
