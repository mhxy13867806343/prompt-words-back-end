# 项目文档

## 概览
- 项目：提示词管理系统后端（FastAPI + SQLAlchemy + Redis）
- 功能：注册/登录、邮箱绑定、找回密码、提示词 CRUD、点赞/收藏、浏览统计、个人中心、全局统计

## 技术栈
- Python 3.11+
- FastAPI、SQLAlchemy (异步)
- PostgreSQL、Redis
- JWT 认证

## 安装与依赖
- 使用 uv（推荐）：
  - `curl -LsSf https://astral.sh/uv/install.sh | sh`
  - `uv sync`
- 使用 pip：
  - `pip install -r requirements.txt`

## 环境变量
- `DATABASE_URL=postgresql+asyncpg://user:password@host:5432/dbname`
- `REDIS_URL=redis://host:6379/0`
- `SECRET_KEY=your-secret`
- `SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASSWORD`、`SMTP_FROM`

## 启动方式
- 本地开发：`uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
- Docker 构建：`docker build -t prompt-words-back-end .`
- Docker 运行：`docker run --rm -p 8000:8000 --env-file .env prompt-words-back-end`

## 常用脚本
- 初始化数据库：`python init_db.py`
- 启动脚本：`bash run.sh`
- 简易 API 测试：`uv run python test_api.py`

## API 快速参考
- 认证：
  - `POST /auth/register` 注册
  - `POST /auth/login` 登录
  - `POST /auth/send-code` 发送邮箱验证码
  - `POST /auth/bind-email` 绑定邮箱
  - `POST /auth/reset-password` 重置密码
  - `POST /auth/logout` 退出登录
- 提示词：
  - `POST /prompts` 创建
  - `GET /prompts?page=1&page_size=10` 列表与分页
  - `GET /prompts/{promptId}` 详情与浏览统计
  - `PUT /prompts/{promptId}` 更新（本人）
  - `DELETE /prompts/{promptId}` 软删除（本人）
  - `GET /prompts/user/my-prompts` 我的提示词
  - `GET /prompts/stats/global` 全局统计

## API 示例

### 注册与登录
请求：
```json
POST /auth/register
{"username":"testuser","password":"123456"}
```
响应：
```json
{"code":200,"data":{"accessToken":"...","tokenType":"bearer","user":{"id":1,"username":"testuser","email":null,"state":0,"createdAt":"..."}},"msg":"成功"}
```

```json
POST /auth/login
{"username":"testuser","password":"123456"}
```

### 邮箱验证码与绑定
发送验证码：
```json
POST /auth/send-code
{"email":"user@example.com"}
```
绑定邮箱：
```json
POST /auth/bind-email (需携带 Bearer Token)
{"email":"user@example.com","code":"123456"}
```

重置密码：
```json
POST /auth/reset-password
{"email":"user@example.com","code":"123456","newPassword":"654321"}
```

退出登录：
```json
POST /auth/logout (需携带 Bearer Token)
{}
```

### 提示词 CRUD
创建：
```json
POST /prompts (需携带 Bearer Token)
{"title":"测试提示词","content":"内容..."}
```
列表与分页：
```text
GET /prompts?page=1&page_size=10
```
详情（自动记录浏览，限IP）：
```text
GET /prompts/123
```
更新：
```json
PUT /prompts/123 (需本人且携带 Token)
{"title":"新标题","content":"新内容"}
```
删除（软删除）：
```text
DELETE /prompts/123 (需本人且携带 Token)
```

### 点赞与收藏切换
```text
POST /prompts/123/like (携带 Token)    # 再次调用为取消
POST /prompts/123/favorite (携带 Token) # 再次调用为取消
```

### 我的列表
```text
GET /prompts/user/my-prompts   (携带 Token)
GET /prompts/user/favorites    (携带 Token)
GET /prompts/user/likes        (携带 Token)
```

### 全局统计
```text
GET /prompts/stats/global
```

## 其他
- API 文档：`http://localhost:8000/docs`
- 返回格式：`{"code":200,"data":{},"msg":"成功"}`，字段使用 camelCase

## 前端对接
- 仓库：`https://github.com/mhxy13867806343/prompt-words-front-end`
- 接口前缀：同时支持 `/{...}` 与 `/api/{...}`，推荐使用 `/api`
- Vite 代理示例：
  ```ts
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
  ```
